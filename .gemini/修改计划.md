# æ–°æ ‡ç­¾é¡µæ’ä»¶ä¼˜åŒ–è®¡åˆ’

## é—®é¢˜æ€»ç»“

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œå½“å‰å­˜åœ¨ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **å£çº¸åˆ‡æ¢åŠŸèƒ½å¡æ­»é—®é¢˜** - ç‚¹å‡»åˆ‡æ¢å£çº¸æŒ‰é’®åç•Œé¢å¡æ­»
2. **å¤©æ°”æ˜¾ç¤ºä¸å‡†ç¡®** - å¤©æ°”æ˜¾ç¤ºä¸å®é™…æ—¶é—´å¯¹ä¸ä¸Šï¼Œåˆ·æ–°é€Ÿåº¦è¾ƒæ…¢
3. **å¸¸ç”¨ç½‘ç«™å ç”¨ç©ºé—´è¿‡å¤§** - TopSitesç»„ä»¶å ç”¨ç©ºé—´ä¸ä¼˜é›…

---

## é—®é¢˜ä¸€ï¼šå£çº¸åˆ‡æ¢å¡æ­»

### é—®é¢˜åˆ†æ

ä½ç½®ï¼š`entrypoints/newtab/components/Plugins/WallpaperSwitcher/index.vue`

å½“å‰åˆ‡æ¢é€»è¾‘ï¼š

- ç›´æ¥ä¿®æ”¹ `settings.background.bgType`
- è°ƒç”¨ `saveSettings(settings)` ä¿å­˜
- ç¼ºä¹è¿‡æ¸¡åŠ¨ç”»å’ŒçŠ¶æ€ç®¡ç†
- å¯èƒ½åœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­è§¦å‘äº†å¤§é‡é‡æ–°æ¸²æŸ“

### è§£å†³æ–¹æ¡ˆ

#### 1.1 ä½¿ç”¨èƒŒæ™¯åˆ‡æ¢çŠ¶æ€ç®¡ç†

åˆ©ç”¨ç°æœ‰çš„ `backgroundSwitchStore` (åœ¨ `entrypoints/newtab/scripts/store/backgroundSwitchStore.ts`)ï¼Œåœ¨åˆ‡æ¢æ—¶æ·»åŠ çŠ¶æ€æ ‡è®°ï¼š

```typescript
async function switchToPrevious() {
  const bgSwitchStore = useBgSwitchStore()
  bgSwitchStore.start()

  await nextTick() // ç­‰å¾…UIæ›´æ–°

  const currentIndex = getCurrentIndex()
  const newIndex = currentIndex === 0 ? bgTypeOrder.length - 1 : currentIndex - 1
  const newBgType = bgTypeOrder[newIndex]

  if (newBgType !== undefined) {
    settings.background.bgType = newBgType
    await saveSettings(settings)
  }

  await promiseTimeout(300) // ç­‰å¾…èƒŒæ™¯åŠ è½½
  bgSwitchStore.end()
}
```

#### 1.2 æ·»åŠ é˜²æŠ–æœºåˆ¶

é˜²æ­¢ç”¨æˆ·å¿«é€Ÿè¿ç»­ç‚¹å‡»å¯¼è‡´çš„å¡é¡¿ï¼š

```typescript
const isSwitching = ref(false)
const switchCooldown = 500 // 500mså†·å´æ—¶é—´

async function switchToPrevious() {
  if (isSwitching.value) return
  isSwitching.value = true

  // ... åˆ‡æ¢é€»è¾‘

  setTimeout(() => {
    isSwitching.value = false
  }, switchCooldown)
}
```

#### 1.3 ä¼˜åŒ–èƒŒæ™¯åŠ è½½é€»è¾‘

åœ¨ `Background.vue` ä¸­ç¡®ä¿èƒŒæ™¯åˆ‡æ¢æ—¶çš„å¹³æ»‘è¿‡æ¸¡ï¼Œé¿å…é—ªçƒã€‚

---

## é—®é¢˜äºŒï¼šå¤©æ°”æ˜¾ç¤ºä¸å‡†ç¡®å’Œåˆ·æ–°æ…¢

### é—®é¢˜åˆ†æ

ä½ç½®ï¼š`entrypoints/newtab/components/Clock.vue`

å½“å‰é—®é¢˜ï¼š

1. å¤©æ°”APIè°ƒç”¨ä¾èµ–åœ°ç†ä½ç½®è·å–ï¼Œå¯èƒ½å»¶è¿Ÿ
2. 30åˆ†é’Ÿåˆ·æ–°é—´éš”å¤ªé•¿
3. é¦–æ¬¡åŠ è½½æ—¶æ²¡æœ‰ç«‹å³è·å–å¤©æ°”
4. åœ°ç†ä½ç½®å¯èƒ½è·å–å¤±è´¥å¯¼è‡´å¤©æ°”æ°¸è¿œä¸æ˜¾ç¤º

### è§£å†³æ–¹æ¡ˆ

#### 2.1 ä¼˜åŒ–åˆå§‹åŒ–é€»è¾‘

```typescript
// åœ¨ç»„ä»¶mountedæ—¶ç«‹å³å°è¯•è·å–å¤©æ°”
onMounted(() => {
  if (coords.value.latitude && coords.value.longitude) {
    fetchWeather()
  }
})

// ç›‘å¬åœ°ç†ä½ç½®å˜åŒ–æ—¶ç«‹å³è·å–
watch(
  () => coords.value,
  (newCoords) => {
    if (newCoords.latitude && newCoords.longitude) {
      fetchWeather()
    }
  },
  { immediate: true }
)
```

#### 2.2 ç¼©çŸ­åˆ·æ–°é—´éš”

```typescript
// ä»30åˆ†é’Ÿæ”¹ä¸º10åˆ†é’Ÿ
useIntervalFn(fetchWeather, 10 * 60 * 1000) // æ¯10åˆ†é’Ÿåˆ·æ–°
```

#### 2.3 æ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®

åœ¨æ—¶é’Ÿæ˜¾ç¤ºåŒºåŸŸæ·»åŠ ä¸€ä¸ªå°çš„åˆ·æ–°å›¾æ ‡ï¼Œå…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°å¤©æ°”ï¼š

```vue
<span v-if="weather" class="clock__weather" @click="fetchWeather" title="ç‚¹å‡»åˆ·æ–°å¤©æ°”">
  Â· {{ weatherIcons[weather.code] || 'ğŸŒ¡ï¸' }} {{ weather.temp }}Â°C ğŸ”„
</span>
```

#### 2.4 æ·»åŠ åŠ è½½çŠ¶æ€æç¤º

```typescript
const weatherLoading = ref(false)

async function fetchWeather() {
  if (!coords.value.latitude || !coords.value.longitude) return

  weatherLoading.value = true
  try {
    // ... åŸæœ‰é€»è¾‘
  } catch (e) {
    console.error('Weather fetch failed', e)
  } finally {
    weatherLoading.value = false
  }
}
```

#### 2.5 æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

```typescript
const weatherRetryCount = ref(0)
const maxRetries = 3

async function fetchWeather() {
  if (!coords.value.latitude || !coords.value.longitude) {
    if (weatherRetryCount.value < maxRetries) {
      weatherRetryCount.value++
      setTimeout(fetchWeather, 5000) // 5ç§’åé‡è¯•
    }
    return
  }

  weatherRetryCount.value = 0 // é‡ç½®é‡è¯•è®¡æ•°
  // ... è·å–å¤©æ°”é€»è¾‘
}
```

#### 2.6 ä½¿ç”¨æµè§ˆå™¨APIè·å–æ—¶åŒº

ç¡®ä¿APIè°ƒç”¨ä¸­çš„ `timezone=auto` æ­£ç¡®å·¥ä½œï¼Œæˆ–æ‰‹åŠ¨è·å–æ—¶åŒºï¼š

```typescript
const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone

const res = await fetch(
  `https://api.open-meteo.com/v1/forecast?latitude=${coords.value.latitude}&longitude=${coords.value.longitude}&current=temperature_2m,weather_code&timezone=${encodeURIComponent(timezone)}`
)
```

---

## é—®é¢˜ä¸‰ï¼šå¸¸ç”¨ç½‘ç«™å ç”¨ç©ºé—´è¿‡å¤§

### é—®é¢˜åˆ†æ

ä½ç½®ï¼š`entrypoints/newtab/components/BookmarkMenu/components/TopSites.vue`

å½“å‰é—®é¢˜ï¼š

1. æ¯ä¸ªç«™ç‚¹å¡ç‰‡å ç”¨è¾ƒå¤§ç©ºé—´ (padding: 16px 12px)
2. ç½‘æ ¼å¸ƒå±€ä¸º 4åˆ—ï¼Œåœ¨å¤§å±å¹•ä¸Šæµªè´¹ç©ºé—´
3. å›¾æ ‡å°ºå¯¸(48px)å’Œä¿¡æ¯æ˜¾ç¤ºå ç”¨è¿‡å¤šå‚ç›´ç©ºé—´

### è§£å†³æ–¹æ¡ˆ

#### 3.1 ä¼˜åŒ–å¡ç‰‡å°ºå¯¸å’Œé—´è·

```scss
.site-card {
  padding: 10px 8px; // ä» 16px 12px å‡å°åˆ° 10px 8px
  gap: 6px; // ä» 8px å‡å°åˆ° 6px
}

.site-favicon {
  width: 36px; // ä» 48px å‡å°åˆ° 36px
  height: 36px;
  border-radius: 10px; // ä» 12px å‡å°åˆ° 10px

  img {
    width: 24px; // ä» 32px å‡å°åˆ° 24px
    height: 24px;
  }
}
```

#### 3.2 æ”¹è¿›ç½‘æ ¼å¸ƒå±€

ä½¿ç”¨å“åº”å¼è®¾è®¡ï¼Œæ ¹æ®å±å¹•å®½åº¦è‡ªé€‚åº”åˆ—æ•°ï¼š

```scss
&__grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); // è‡ªé€‚åº”
  gap: 8px; // ä» 12px å‡å°åˆ° 8px

  @media (min-width: 1200px) {
    grid-template-columns: repeat(6, 1fr); // å¤§å±å¹•æ˜¾ç¤º6åˆ—
  }

  @media (min-width: 768px) and (max-width: 1199px) {
    grid-template-columns: repeat(5, 1fr); // ä¸­ç­‰å±å¹•5åˆ—
  }

  @media (max-width: 767px) {
    grid-template-columns: repeat(3, 1fr); // å°å±å¹•3åˆ—
  }
}
```

#### 3.3 ç´§å‡‘æ¨¡å¼é€‰é¡¹

æ·»åŠ ä¸€ä¸ªè®¾ç½®é€‰é¡¹ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©ç´§å‡‘æ¨¡å¼ï¼š

```scss
// åœ¨ç´§å‡‘æ¨¡å¼ä¸‹è¿›ä¸€æ­¥å‡å°å°ºå¯¸
.top-sites.compact {
  margin-bottom: 16px; // ä» 24px å‡å°

  .site-card {
    padding: 8px 6px;
  }

  .site-favicon {
    width: 32px;
    height: 32px;

    img {
      width: 20px;
      height: 20px;
    }
  }

  .site-title {
    font-size: 12px; // ä» 13px å‡å°
  }

  .site-count {
    font-size: 10px; // ä» 11px å‡å°
  }
}
```

#### 3.4 ä¼˜åŒ–TopSitesæ•´ä½“å¸ƒå±€

å‡å°‘æ•´ä¸ªç»„ä»¶çš„å¤–è¾¹è·ï¼š

```scss
.top-sites {
  margin-bottom: 16px; // ä» 24px å‡å°åˆ° 16px

  &__header {
    margin-bottom: 8px; // ä» 12px å‡å°åˆ° 8px
    padding: 0 2px; // ä» 0 4px å‡å°
  }
}
```

#### 3.5 å¯é€‰ï¼šé™åˆ¶æ˜¾ç¤ºæ•°é‡

åœ¨ `BookmarkMenu/index.vue` ä¸­ä¼ é€’çš„ç«™ç‚¹æ•°é‡å¯ä»¥ä»8å‡å°‘åˆ°6ï¼š

```typescript
function loadTopSites() {
  topSites.value = visitTracker.getTopSites(6) // ä»8æ”¹ä¸º6
}
```

#### 3.6 æ°´å¹³æ»šåŠ¨å¸ƒå±€ï¼ˆå¯é€‰æ–¹æ¡ˆï¼‰

å¦‚æœç”¨æˆ·å¸Œæœ›æ›´ç´§å‡‘ï¼Œå¯ä»¥è€ƒè™‘æ”¹ä¸ºæ°´å¹³æ»šåŠ¨å¸ƒå±€ï¼š

```scss
&__grid {
  display: flex;
  flex-direction: row;
  gap: 8px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding-bottom: 8px;

  &::-webkit-scrollbar {
    height: 4px;
  }

  &::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
  }
}

.site-card {
  flex: 0 0 auto;
  width: 90px;
}
```

---

## å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

1. **å£çº¸åˆ‡æ¢å¡æ­»** - ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒ
2. **å¤©æ°”åˆ·æ–°æ…¢** - æ·»åŠ æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½

### ä¸­ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–ä½“éªŒï¼‰

3. **å¸¸ç”¨ç½‘ç«™å°ºå¯¸ä¼˜åŒ–** - æ”¹è¿›UIç¾è§‚æ€§
4. **å¤©æ°”åˆå§‹åŒ–ä¼˜åŒ–** - æå‡é¦–æ¬¡åŠ è½½ä½“éªŒ

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

5. æ·»åŠ å£çº¸æ‰¹é‡é€‰æ‹©å’Œå·¦å³åˆ‡æ¢åŠŸèƒ½
6. æ·»åŠ ç´§å‡‘æ¨¡å¼è®¾ç½®é€‰é¡¹

---

## å…³äºæ‰¹é‡é€‰æ‹©æœ¬åœ°å›¾ç‰‡åŠŸèƒ½

ç”¨æˆ·æåˆ°å¸Œæœ›"åœ¨èƒŒæ™¯èœå•æ å¢åŠ å¯ä»¥æ‰¹é‡é€‰æ‹©å¤šä¸ªæœ¬åœ°å›¾ç‰‡ï¼Œç„¶åå¯ä»¥å·¦å³åˆ‡æ¢"ã€‚

### å®ç°æ–¹æ¡ˆ

#### 4.1 æ‰©å±•æœ¬åœ°èƒŒæ™¯å­˜å‚¨

å½“å‰åªæ”¯æŒä¸€å¼ æ˜äº®æ¨¡å¼å’Œä¸€å¼ æš—è‰²æ¨¡å¼çš„å£çº¸ï¼Œéœ€è¦æ‰©å±•ä¸ºæ”¯æŒå¤šå¼ ï¼š

```typescript
// åœ¨ shared/settings/types/v8.d.ts ä¸­æ‰©å±•ç±»å‹
interface LocalBackgroundConfig {
  id: string
  url: string
  mediaType?: 'image' | 'video'
}

interface BackgroundSettings {
  // ... å…¶ä»–è®¾ç½®
  localBackgrounds: LocalBackgroundConfig[] // æ–°å¢ï¼šå¤šå¼ å£çº¸æ•°ç»„
  localDarkBackgrounds: LocalBackgroundConfig[] // æ–°å¢ï¼šå¤šå¼ æš—è‰²å£çº¸æ•°ç»„
  currentBackgroundIndex: number // æ–°å¢ï¼šå½“å‰å£çº¸ç´¢å¼•
  currentDarkBackgroundIndex: number // æ–°å¢ï¼šå½“å‰æš—è‰²å£çº¸ç´¢å¼•
}
```

#### 4.2 ä¿®æ”¹ä¸Šä¼ é€»è¾‘

åœ¨ `BackgroundSettings.vue` ä¸­æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼š

```vue
<el-upload
  :multiple="true"
  :limit="10"
  :on-exceed="handleExceed"
  :http-request="(option) => handleBatchUpload(option)"
  accept="image/*"
>
  <el-button>æ‰¹é‡ä¸Šä¼ å£çº¸</el-button>
</el-upload>

<!-- æ˜¾ç¤ºå·²ä¸Šä¼ çš„å£çº¸åˆ—è¡¨ -->
<div class="wallpaper-list">
  <div v-for="(bg, index) in settings.localBackgrounds" :key="bg.id">
    <img :src="bg.url" @click="setCurrentBackground(index)" />
    <el-button @click="removeBackground(index)">åˆ é™¤</el-button>
  </div>
</div>
```

#### 4.3 ä¿®æ”¹WallpaperSwitcheré€»è¾‘

å°†å½“å‰çš„èƒŒæ™¯ç±»å‹åˆ‡æ¢æ”¹ä¸ºåœ¨å¤šå¼ æœ¬åœ°å£çº¸é—´åˆ‡æ¢ï¼š

```typescript
// å½“èƒŒæ™¯ç±»å‹ä¸ºLocalæ—¶ï¼Œå·¦å³ç®­å¤´åˆ‡æ¢ä¸åŒçš„æœ¬åœ°å£çº¸
function switchToPrevious() {
  if (settings.background.bgType === BgType.Local) {
    const isDark = useDark().value
    const backgrounds = isDark ? settings.localDarkBackgrounds : settings.localBackgrounds
    const currentIndex = isDark
      ? settings.currentDarkBackgroundIndex
      : settings.currentBackgroundIndex

    if (backgrounds.length > 1) {
      const newIndex = currentIndex === 0 ? backgrounds.length - 1 : currentIndex - 1
      if (isDark) {
        settings.currentDarkBackgroundIndex = newIndex
      } else {
        settings.currentBackgroundIndex = newIndex
      }
      saveSettings(settings)
      return
    }
  }

  // åŸæœ‰é€»è¾‘ï¼šåˆ‡æ¢èƒŒæ™¯ç±»å‹
  // ...
}
```

#### 4.4 ä¿®æ”¹Background.vueä½¿ç”¨å½“å‰ç´¢å¼•

```vue
<script>
const currentBackgroundUrl = computed(() => {
  if (settings.background.bgType !== BgType.Local) {
    return props.url
  }

  const isDark = useDark().value
  const backgrounds = isDark ? settings.localDarkBackgrounds : settings.localBackgrounds
  const currentIndex = isDark
    ? settings.currentDarkBackgroundIndex
    : settings.currentBackgroundIndex

  return backgrounds[currentIndex]?.url || props.url
})
</script>

<template>
  <div :style="{ backgroundImage: `url(${currentBackgroundUrl})` }"></div>
</template>
```

---

## æµ‹è¯•è®¡åˆ’

### æµ‹è¯•1: å£çº¸åˆ‡æ¢

- [ ] å¿«é€Ÿè¿ç»­ç‚¹å‡»å·¦å³ç®­å¤´ï¼Œç¡®è®¤ä¸å¡æ­»
- [ ] æ£€æŸ¥åˆ‡æ¢åŠ¨ç”»æ˜¯å¦æµç•…
- [ ] éªŒè¯èƒŒæ™¯æ­£ç¡®åˆ‡æ¢ä¸”ä¿å­˜

### æµ‹è¯•2: å¤©æ°”æ˜¾ç¤º

- [ ] é¦–æ¬¡æ‰“å¼€é¡µé¢ï¼Œå¤©æ°”æ˜¯å¦åœ¨åˆç†æ—¶é—´å†…æ˜¾ç¤º
- [ ] æ‰‹åŠ¨åˆ·æ–°å¤©æ°”æ˜¯å¦å·¥ä½œ
- [ ] 10åˆ†é’Ÿåå¤©æ°”æ˜¯å¦è‡ªåŠ¨åˆ·æ–°
- [ ] æ— åœ°ç†ä½ç½®æƒé™æ—¶çš„é™çº§å¤„ç†

### æµ‹è¯•3: å¸¸ç”¨ç½‘ç«™

- [ ] åœ¨ä¸åŒå±å¹•å°ºå¯¸ä¸‹æ£€æŸ¥å¸ƒå±€
- [ ] ç¡®è®¤å ç”¨ç©ºé—´å‡å°‘ä¸”ä»ç„¶ç¾è§‚
- [ ] å“åº”å¼å¸ƒå±€åœ¨å„ç§åˆ†è¾¨ç‡ä¸‹æ­£å¸¸å·¥ä½œ

### æµ‹è¯•4: æ‰¹é‡å£çº¸ï¼ˆå¦‚æœå®ç°ï¼‰

- [ ] æ‰¹é‡ä¸Šä¼ å¤šå¼ å›¾ç‰‡
- [ ] å·¦å³åˆ‡æ¢åœ¨å¤šå¼ å£çº¸é—´æ­£ç¡®å·¥ä½œ
- [ ] åˆ é™¤å£çº¸åŠŸèƒ½æ­£å¸¸
- [ ] æ˜äº®/æš—è‰²æ¨¡å¼åˆ†åˆ«ç®¡ç†å„è‡ªçš„å£çº¸é›†åˆ

---

## æ–‡ä»¶æ¸…å•

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š

1. `entrypoints/newtab/components/Plugins/WallpaperSwitcher/index.vue` - ä¿®å¤å¡æ­»é—®é¢˜
2. `entrypoints/newtab/components/Clock.vue` - ä¼˜åŒ–å¤©æ°”æ˜¾ç¤º
3. `entrypoints/newtab/components/BookmarkMenu/components/TopSites.vue` - ä¼˜åŒ–å°ºå¯¸
4. `entrypoints/newtab/components/SettingsPage/Settings/BackgroundSettings.vue` - ï¼ˆå¦‚æœå®ç°æ‰¹é‡å£çº¸ï¼‰
5. `shared/settings/types/v8.d.ts` - ï¼ˆå¦‚æœå®ç°æ‰¹é‡å£çº¸ï¼‰æ‰©å±•ç±»å‹å®šä¹‰
6. `entrypoints/newtab/scripts/store/backgroundSwitchStore.ts` - å¯èƒ½éœ€è¦æ‰©å±•

---

## é¢„è®¡å·¥ä½œé‡

- é—®é¢˜ä¸€ï¼ˆå£çº¸åˆ‡æ¢å¡æ­»ï¼‰ï¼š1-2å°æ—¶
- é—®é¢˜äºŒï¼ˆå¤©æ°”ä¼˜åŒ–ï¼‰ï¼š1-2å°æ—¶
- é—®é¢˜ä¸‰ï¼ˆå¸¸ç”¨ç½‘ç«™å°ºå¯¸ï¼‰ï¼š1å°æ—¶
- æ‰¹é‡å£çº¸åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰ï¼š4-6å°æ—¶

æ€»è®¡ï¼šçº¦ 3-5 å°æ—¶ï¼ˆä¸åŒ…å«æ‰¹é‡å£çº¸åŠŸèƒ½ï¼‰
æ€»è®¡ï¼šçº¦ 7-11 å°æ—¶ï¼ˆåŒ…å«æ‰¹é‡å£çº¸åŠŸèƒ½ï¼‰
